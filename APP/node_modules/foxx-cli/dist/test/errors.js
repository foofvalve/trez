/* global describe, it, before, after */
"use strict";

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

const http = require("http");
const expect = require("chai").expect;
const foxx = require("./util");
const errors = require("../errors");

let HOST;
let ERROR;
const server = http.createServer((req, res) => {
  res.writeHead(500, {
    server: "Fake ArangoDB",
    "content-type": "application/json"
  });
  res.end(JSON.stringify({
    error: true,
    code: 500,
    errorNum: ERROR,
    errorMessage: "Something went wrong"
  }));
});

describe("Error handling", () => {
  before(done => {
    server.listen(e => {
      if (!e) HOST = `tcp://localhost:${server.address().port}`;
      done(e);
    });
  });
  after(done => {
    server.close(e => {
      done(e);
    });
  });
  describe("Foxx config", () => {
    it("correctly handles SERVICE_NOT_FOUND", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_SERVICE_NOT_FOUND;
      try {
        yield foxx(`config -H ${HOST} /myfoxx`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.include("/myfoxx");
        return;
      }
      expect.fail();
    }));
  });
  describe("Foxx deps", () => {
    it("correctly handles SERVICE_NOT_FOUND", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_SERVICE_NOT_FOUND;
      try {
        yield foxx(`deps -H ${HOST} /myfoxx`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.include("/myfoxx");
        return;
      }
      expect.fail();
    }));
  });
  describe("Foxx download", () => {
    it("correctly handles SERVICE_NOT_FOUND", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_SERVICE_NOT_FOUND;
      try {
        yield foxx(`download -H ${HOST} /myfoxx`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.include("/myfoxx");
        return;
      }
      expect.fail();
    }));
  });
  describe("Foxx install", () => {
    it("correctly handles INVALID_MOUNTPOINT", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_INVALID_MOUNTPOINT;
      try {
        yield foxx(`install -H ${HOST} -R /myfoxx /dev/null`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.include("/myfoxx");
        return;
      }
      expect.fail();
    }));
    it("correctly handles SERVICE_MOUNTPOINT_CONFLICT", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_SERVICE_MOUNTPOINT_CONFLICT;
      try {
        yield foxx(`install -H ${HOST} -R /myfoxx /dev/null`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.include("/myfoxx");
        return;
      }
      expect.fail();
    }));
    it("correctly handles SERVICE_SOURCE_NOT_FOUND", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_SERVICE_SOURCE_NOT_FOUND;
      try {
        yield foxx(`install -H ${HOST} -R /myfoxx /dev/null`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.match(/resolve/i);
        return;
      }
      expect.fail();
    }));
    it("correctly handles SERVICE_SOURCE_ERROR", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_SERVICE_SOURCE_ERROR;
      try {
        yield foxx(`install -H ${HOST} -R /myfoxx /dev/null`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.match(/download/i);
        return;
      }
      expect.fail();
    }));
    it("correctly handles SERVICE_MANIFEST_NOT_FOUND", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_SERVICE_MANIFEST_NOT_FOUND;
      try {
        yield foxx(`install -H ${HOST} -R /myfoxx /dev/null`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.match(/manifest/i);
        return;
      }
      expect.fail();
    }));
    it("correctly handles MALFORMED_MANIFEST_FILE", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_MALFORMED_MANIFEST_FILE;
      try {
        yield foxx(`install -H ${HOST} -R /myfoxx /dev/null`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.match(/manifest/i);
        return;
      }
      expect.fail();
    }));
    it("correctly handles INVALID_SERVICE_MANIFEST", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_INVALID_SERVICE_MANIFEST;
      try {
        yield foxx(`install -H ${HOST} -R /myfoxx /dev/null`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.match(/manifest/i);
        return;
      }
      expect.fail();
    }));
  });
  describe("Foxx replace", () => {
    it("correctly handles SERVICE_NOT_FOUND", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_SERVICE_NOT_FOUND;
      try {
        yield foxx(`replace -H ${HOST} -R /myfoxx /dev/null`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.include("/myfoxx");
        return;
      }
      expect.fail();
    }));
    it("correctly handles SERVICE_SOURCE_NOT_FOUND", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_SERVICE_SOURCE_NOT_FOUND;
      try {
        yield foxx(`replace -H ${HOST} -R /myfoxx /dev/null`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.match(/resolve/i);
        return;
      }
      expect.fail();
    }));
    it("correctly handles SERVICE_SOURCE_ERROR", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_SERVICE_SOURCE_ERROR;
      try {
        yield foxx(`replace -H ${HOST} -R /myfoxx /dev/null`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.match(/download/i);
        return;
      }
      expect.fail();
    }));
    it("correctly handles SERVICE_MANIFEST_NOT_FOUND", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_SERVICE_MANIFEST_NOT_FOUND;
      try {
        yield foxx(`replace -H ${HOST} -R /myfoxx /dev/null`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.match(/manifest/i);
        return;
      }
      expect.fail();
    }));
    it("correctly handles MALFORMED_MANIFEST_FILE", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_MALFORMED_MANIFEST_FILE;
      try {
        yield foxx(`replace -H ${HOST} -R /myfoxx /dev/null`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.match(/manifest/i);
        return;
      }
      expect.fail();
    }));
    it("correctly handles INVALID_SERVICE_MANIFEST", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_INVALID_SERVICE_MANIFEST;
      try {
        yield foxx(`replace -H ${HOST} -R /myfoxx /dev/null`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.match(/manifest/i);
        return;
      }
      expect.fail();
    }));
  });
  describe("Foxx run", () => {
    it("correctly handles SERVICE_NOT_FOUND", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_SERVICE_NOT_FOUND;
      try {
        yield foxx(`run -H ${HOST} /myfoxx send-mail`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.include("/myfoxx");
        return;
      }
      expect.fail();
    }));
    it("correctly handles SERVICE_NEEDS_CONFIGURATION", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_SERVICE_NEEDS_CONFIGURATION;
      try {
        yield foxx(`run -H ${HOST} /myfoxx send-mail`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.include("/myfoxx");
        expect(stderr).to.match(/config/i);
        return;
      }
      expect.fail();
    }));
    it("correctly handles SERVICE_UNKNOWN_SCRIPT", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_SERVICE_UNKNOWN_SCRIPT;
      try {
        yield foxx(`run -H ${HOST} /myfoxx send-mail`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.include("send-mail");
        return;
      }
      expect.fail();
    }));
    it("correctly handles MODULE_NOT_FOUND", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_MODULE_NOT_FOUND;
      try {
        yield foxx(`run -H ${HOST} /myfoxx send-mail`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.match(/include/i);
        return;
      }
      expect.fail();
    }));
    it("correctly handles MODULE_FAILURE", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_MODULE_FAILURE;
      try {
        yield foxx(`run -H ${HOST} /myfoxx send-mail`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        return;
      }
      expect.fail();
    }));
  });
  describe("Foxx scripts", () => {
    it("correctly handles SERVICE_NOT_FOUND", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_SERVICE_NOT_FOUND;
      try {
        yield foxx(`scripts -H ${HOST} /myfoxx`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.include("/myfoxx");
        return;
      }
      expect.fail();
    }));
  });
  describe("Foxx set-dev", () => {
    it("correctly handles SERVICE_NOT_FOUND", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_SERVICE_NOT_FOUND;
      try {
        yield foxx(`set-dev -H ${HOST} /myfoxx`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.include("/myfoxx");
        return;
      }
      expect.fail();
    }));
  });
  describe("Foxx set-prod", () => {
    it("correctly handles SERVICE_NOT_FOUND", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_SERVICE_NOT_FOUND;
      try {
        yield foxx(`set-prod -H ${HOST} /myfoxx`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.include("/myfoxx");
        return;
      }
      expect.fail();
    }));
  });
  describe("Foxx show", () => {
    it("correctly handles SERVICE_NOT_FOUND", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_SERVICE_NOT_FOUND;
      try {
        yield foxx(`show -H ${HOST} /myfoxx`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.include("/myfoxx");
        return;
      }
      expect.fail();
    }));
  });
  describe("Foxx test", () => {
    it("correctly handles SERVICE_NOT_FOUND", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_SERVICE_NOT_FOUND;
      try {
        yield foxx(`test -H ${HOST} /myfoxx`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.include("/myfoxx");
        return;
      }
      expect.fail();
    }));
    it("correctly handles SERVICE_NEEDS_CONFIGURATION", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_SERVICE_NEEDS_CONFIGURATION;
      try {
        yield foxx(`test -H ${HOST} /myfoxx`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.include("/myfoxx");
        expect(stderr).to.match(/config/i);
        return;
      }
      expect.fail();
    }));
    it("correctly handles MODULE_NOT_FOUND", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_MODULE_NOT_FOUND;
      try {
        yield foxx(`test -H ${HOST} /myfoxx`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.match(/include/i);
        return;
      }
      expect.fail();
    }));
    it("correctly handles MODULE_FAILURE", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_MODULE_FAILURE;
      try {
        yield foxx(`test -H ${HOST} /myfoxx`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.match(/manifest/i);
        return;
      }
      expect.fail();
    }));
  });
  describe("Foxx upgrade", () => {
    it("correctly handles SERVICE_NOT_FOUND", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_SERVICE_NOT_FOUND;
      try {
        yield foxx(`upgrade -H ${HOST} -R /myfoxx /dev/null`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.include("/myfoxx");
        return;
      }
      expect.fail();
    }));
    it("correctly handles SERVICE_SOURCE_NOT_FOUND", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_SERVICE_SOURCE_NOT_FOUND;
      try {
        yield foxx(`upgrade -H ${HOST} -R /myfoxx /dev/null`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.match(/resolve/i);
        return;
      }
      expect.fail();
    }));
    it("correctly handles SERVICE_SOURCE_ERROR", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_SERVICE_SOURCE_ERROR;
      try {
        yield foxx(`upgrade -H ${HOST} -R /myfoxx /dev/null`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.match(/download/i);
        return;
      }
      expect.fail();
    }));
    it("correctly handles SERVICE_MANIFEST_NOT_FOUND", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_SERVICE_MANIFEST_NOT_FOUND;
      try {
        yield foxx(`upgrade -H ${HOST} -R /myfoxx /dev/null`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.match(/manifest/i);
        return;
      }
      expect.fail();
    }));
    it("correctly handles MALFORMED_MANIFEST_FILE", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_MALFORMED_MANIFEST_FILE;
      try {
        yield foxx(`upgrade -H ${HOST} -R /myfoxx /dev/null`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.match(/manifest/i);
        return;
      }
      expect.fail();
    }));
    it("correctly handles INVALID_SERVICE_MANIFEST", _asyncToGenerator(function* () {
      ERROR = errors.ERROR_INVALID_SERVICE_MANIFEST;
      try {
        yield foxx(`upgrade -H ${HOST} -R /myfoxx /dev/null`);
      } catch (e) {
        const stderr = e.stderr.toString("utf-8");
        expect(stderr).not.to.match(/unexpected/i);
        expect(stderr).to.match(/manifest/i);
        return;
      }
      expect.fail();
    }));
  });
});